<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç ‚Äî –°—Ç–æ–ª–æ–≤–∞—è</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; margin: 0; padding: 20px; color: #1a1a1a; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }

        /* –®–∞–ø–∫–∞ */
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #f0f2f5; padding-bottom: 20px; margin-bottom: 20px; }
        .role-badge { background: #8e44ad; color: white; padding: 5px 12px; border-radius: 20px; font-size: 14px; font-weight: bold; }
        .admin-btn { background: #e67e22; color: white; text-decoration: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; font-size: 14px; }

        /* –°–æ–æ–±—â–µ–Ω–∏—è (Flash) */
        .flash-messages { margin-bottom: 20px; }
        .flash { padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid transparent; }
        .flash-success { background: #d4edda; color: #155724; border-color: #c3e6cb; }
        .flash-error { background: #f8d7da; color: #721c24; border-color: #f5c6cb; }

        /* –ü—Ä–æ—Ñ–∏–ª—å –∏ –∫–æ—à–µ–ª–µ–∫ */
        .profile-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .info-card { background: #f8f9fa; padding: 20px; border-radius: 12px; border: 1px solid #e9ecef; position: relative; }
        .wallet-val { font-family: monospace; font-size: 16px; color: #2c3e50; display: block; margin-top: 10px; font-weight: bold; }

        /* –§–æ—Ä–º—ã */
        .pref-form { display: flex; flex-direction: column; gap: 10px; }
        .pref-input { padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; width: 100%; box-sizing: border-box; }
        .btn-save { background: #27ae60; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-save:hover { background: #219150; }

        /* –ú–µ–Ω—é */
        .menu-section { background: #fff; border: 1px solid #eee; padding: 20px; border-radius: 12px; margin-bottom: 30px; }
        .nav-tabs { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
        .tab { text-decoration: none; padding: 8px 16px; background: #eee; border-radius: 20px; color: #666; font-size: 13px; white-space: nowrap; }
        .tab.active { background: #3498db; color: white; }

        .order-row { display: flex; gap: 10px; margin-bottom: 20px; }
        select { flex-grow: 1; padding: 12px; border-radius: 8px; border: 1px solid #ddd; background: white; }
        .btn-order { background: #3498db; color: white; border: none; padding: 0 25px; border-radius: 8px; cursor: pointer; font-weight: bold; }

        /* –¢–∞–±–ª–∏—Ü—ã */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; color: #888; font-size: 12px; padding: 10px; border-bottom: 2px solid #f0f2f5; }
        td { padding: 12px 10px; border-bottom: 1px solid #f9f9f9; font-size: 14px; }

        .status { font-weight: bold; padding: 4px 8px; border-radius: 4px; font-size: 11px; text-transform: uppercase; }
        .status-–æ–¥–æ–±—Ä–µ–Ω–æ { background: #d4edda; color: #155724; }
        .status-–≤-–æ–∂–∏–¥–∞–Ω–∏–∏ { background: #fff3cd; color: #856404; }
        .status-–æ—Ç–∫–ª–æ–Ω–µ–Ω–æ { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>

<div class="container">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-messages">
          {% for category, message in messages %}
            <div class="flash flash-{{ category or 'success' }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <div class="header">
        <div>
            <h1 style="margin: 0;">–ü—Ä–∏–≤–µ—Ç, {{ user.login }}!</h1>
            <span class="role-badge">{{ user_role_ru }}</span>
        </div>
        <div style="display: flex; gap: 10px;">
            {% if user.role == 'admin' %}
                <a href="/admin/panel" class="admin-btn">‚öôÔ∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</a>
            {% endif %}
            {% if user.role in ['cook', 'admin'] %}
                <a href="/cook/storage" class="admin-btn" style="background: #27ae60;">üë®‚Äçüç≥ –°–ö–õ–ê–î</a>
            {% endif %}
        </div>
    </div>

    <div class="profile-grid">
        <div class="info-card">
            <strong style="color: #7f8c8d;">–í–∞—à –ª–∏—á–Ω—ã–π —Å—á–µ—Ç</strong>
            <span class="wallet-val">{{ wallet_number }}</span>
            <small style="color: #95a5a6; display: block; margin-top: 5px;">Email: {{ user.email or '–Ω–µ —É–∫–∞–∑–∞–Ω' }}</small>
            <a href="/wallet" style="display:inline-block; margin-top:15px; font-size:12px; color:#3498db; text-decoration:none;">‚ûï –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å / –ò—Å—Ç–æ—Ä–∏—è</a>
        </div>

        <div class="info-card">
            <form action="/" method="POST" class="pref-form">
                <input type="text" name="update_allergies" class="pref-input"
                       value="{{ user.allergen or '' }}" placeholder="–í–∞—à–∏ –∞–ª–ª–µ—Ä–≥–∏–∏...">
                <input type="text" name="update_preferences" class="pref-input"
                       value="{{ user.preferences or '' }}" placeholder="–ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è (–±–µ–∑ –ª—É–∫–∞ –∏ —Ç.–¥.)">
                <button type="submit" class="btn-save">üíæ –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
            </form>
        </div>
    </div>

    <div class="menu-section">
        <h3>üçΩÔ∏è –ó–∞–∫–∞–∑–∞—Ç—å –µ–¥—É</h3>
        <div class="nav-tabs">
            <a href="/" class="tab {{ 'active' if current_category == '–í—Å–µ' }}">–í—Å–µ</a>
            {% for cat in categories %}
                <a href="/?category={{ cat }}" class="tab {{ 'active' if current_category == cat }}">{{ cat }}</a>
            {% endfor %}
        </div>

        <form action="/create_request" method="POST" class="order-row">
            <select name="item_name" required>
                {% for item in menu %}
                    <option value="{{ item.name }}">
                        {{ item.name }} ‚Äî {{ item.price }} —Ä—É–±. ({{ item.count }} —à—Ç.)
                    </option>
                {% else %}
                    <option disabled>–ù–∞ —Å–∫–ª–∞–¥–µ –Ω–∏—á–µ–≥–æ –Ω–µ—Ç :(</option>
                {% endfor %}
            </select>
            <button type="submit" class="btn-order">–ö—É–ø–∏—Ç—å</button>
        </form>
    </div>

    {% if user.role == 'admin' %}
    <div class="menu-section" style="border-color: #e67e22;">
        <h3>üí∞ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω–∞–º–∏ (–ê–¥–º–∏–Ω)</h3>
        <table>
            {% for item in menu %}
            <tr>
                <td>{{ item.name }}</td>
                <td>
                    <form action="/admin/update_price" method="POST" style="display:flex; gap:10px;">
                        <input type="hidden" name="item_id" value="{{ item.id }}">
                        <input type="number" name="price" value="{{ item.price }}" style="width:70px;" class="pref-input">
                        <button type="submit" class="btn-save" style="padding: 5px 10px;">–û–ö</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </table>
    </div>
    {% endif %}

    <h3>‚è≥ –ú–æ–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ–∫—É–ø–∫–∏</h3>
    <table>
        <thead>
            <tr>
                <th>–î–∞—Ç–∞</th>
                <th>–ü—Ä–æ–¥—É–∫—Ç</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
            </tr>
        </thead>
        <tbody>
            {% for r in my_requests %}
            <tr>
                <td>{{ r.date.strftime('%d.%m %H:%M') }}</td>
                <td><strong>{{ r.product }}</strong></td>
                <td>
                    <span class="status status-{{ r.status.lower().replace(' ', '-') }}">
                        {{ r.status }}
                    </span>
                </td>
            </tr>
            {% else %}
            <tr><td colspan="3" style="text-align: center; color: #999; padding: 20px;">–í—ã –µ—â–µ –Ω–∏—á–µ–≥–æ –Ω–µ –∑–∞–∫–∞–∑—ã–≤–∞–ª–∏</td></tr>
            {% endfor %}
        </tbody>
    </table>

    <div style="text-align: center; margin-top: 40px; border-top: 1px solid #eee; padding-top: 20px;">
        <a href="/logout" style="color: #e74c3c; text-decoration: none; font-size: 14px; font-weight: bold;">üö™ –í—ã–π—Ç–∏ –∏–∑ –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞</a>
    </div>
</div>

</body>
</html>